#include <criterion/criterion.h>
#include "ssq/response.h"

Test(response, haschall_yes, .description = "Response has a challenge") {
    const char   response[]   = { S2A_HEADER_CHALL, 0xDE, 0xAD, 0xBE, 0xEF };
    const size_t response_len = sizeof (response);

    cr_expect(ssq_response_haschall(response, response_len));
}

Test(response, haschall_no, .description = "Response does not have challenge") {
    const uint8_t not_s2a_header_chall = ~S2A_HEADER_CHALL;

    const char   response[]   = { not_s2a_header_chall, 0xDE, 0xAD, 0xBE, 0xEF };
    const size_t response_len = sizeof (response);

    cr_expect(!ssq_response_haschall(response, response_len));
}

Test(response, getchall, .description = "Get challenge from response") {
    const int32_t chall = 0xDEADBEEF;

    const size_t response_len = 1 + sizeof (chall);
    char         response[response_len];

    response[0] = S2A_HEADER_CHALL;
    memcpy(response + 1, &chall, sizeof (chall));

    cr_expect_eq(ssq_response_getchall(response, response_len), chall);
}

Test(response, istruncated_yes, .description = "Response was truncated") {
   const char response[] = {
        0xFF, 0xFF, 0xFF, 0xFF, 0x45, 0x5D, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x62, 0x6F,
        0x6D, 0x62, 0x5F, 0x76, 0x69, 0x65, 0x77, 0x61, 0x62, 0x6C, 0x65, 0x5F, 0x63, 0x68, 0x65, 0x63,
        0x6B, 0x5F, 0x69, 0x6E, 0x74, 0x65, 0x72, 0x76, 0x61, 0x6C, 0x00, 0x30, 0x2E, 0x35, 0x00, 0x5F,
        0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x64, 0x65, 0x62, 0x75, 0x67, 0x5F, 0x6C, 0x65, 0x76, 0x65,
        0x6C, 0x00, 0x30, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x65, 0x78, 0x61, 0x6D, 0x69,
        0x6E, 0x65, 0x5F, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x30, 0x2E, 0x35, 0x00, 0x5F, 0x74, 0x75, 0x74,
        0x6F, 0x72, 0x5F, 0x68, 0x69, 0x6E, 0x74, 0x5F, 0x69, 0x6E, 0x74, 0x65, 0x72, 0x76, 0x61, 0x6C,
        0x5F, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x31, 0x30, 0x2E, 0x30, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F,
        0x72, 0x5F, 0x6C, 0x6F, 0x6F, 0x6B, 0x5F, 0x61, 0x6E, 0x67, 0x6C, 0x65, 0x00, 0x31, 0x30, 0x00,
        0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x6C, 0x6F, 0x6F, 0x6B, 0x5F, 0x64, 0x69, 0x73, 0x74,
        0x61, 0x6E, 0x63, 0x65, 0x00, 0x32, 0x30, 0x30, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F,
        0x6D, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x5F, 0x63, 0x68, 0x61, 0x72, 0x61, 0x63, 0x74, 0x65,
        0x72, 0x5F, 0x64, 0x69, 0x73, 0x70, 0x6C, 0x61, 0x79, 0x5F, 0x74, 0x69, 0x6D, 0x65, 0x5F, 0x63,
        0x6F, 0x65, 0x66, 0x66, 0x69, 0x63, 0x69, 0x65, 0x6E, 0x74, 0x00, 0x30, 0x2E, 0x30, 0x37, 0x00,
        0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x6D, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x5F, 0x6D,
        0x69, 0x6E, 0x69, 0x6D, 0x75, 0x6D, 0x5F, 0x64, 0x69, 0x73, 0x70, 0x6C, 0x61, 0x79, 0x5F, 0x74,
        0x69, 0x6D, 0x65, 0x00, 0x31, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x6D, 0x65, 0x73,
        0x73, 0x61, 0x67, 0x65, 0x5F, 0x72, 0x65, 0x70, 0x65, 0x61, 0x74, 0x73, 0x00, 0x35, 0x00, 0x5F,
        0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x76, 0x69, 0x65, 0x77, 0x5F, 0x64, 0x69, 0x73, 0x74, 0x61,
        0x6E, 0x63, 0x65, 0x00, 0x31, 0x30, 0x30, 0x30, 0x00, 0x61, 0x6C, 0x6C, 0x6F, 0x77, 0x5F, 0x73,
        0x70, 0x65, 0x63, 0x74, 0x61, 0x74, 0x6F, 0x72, 0x73, 0x00, 0x31, 0x00, 0x61, 0x6D, 0x78, 0x5F,
        0x63, 0x6C, 0x69, 0x65, 0x6E, 0x74, 0x5F, 0x6C, 0x61, 0x6E, 0x67, 0x75, 0x61, 0x67, 0x65, 0x73,
        0x00, 0x31, 0x00, 0x61, 0x6D, 0x78, 0x5F, 0x6C, 0x61, 0x6E, 0x67, 0x75, 0x61, 0x67, 0x65, 0x00,
        0x66, 0x72, 0x00, 0x61, 0x6D, 0x78, 0x5F, 0x6E, 0x65, 0x78, 0x74, 0x6D, 0x61, 0x70, 0x00, 0x64,
        0x65, 0x5F, 0x61, 0x7A, 0x74, 0x65, 0x63, 0x00, 0x61, 0x6D, 0x78, 0x5F, 0x74, 0x69, 0x6D, 0x65,
        0x6C, 0x65, 0x66, 0x74, 0x00, 0x30, 0x30, 0x3A, 0x30, 0x30, 0x00, 0x61, 0x6D, 0x78, 0x6D, 0x6F,
        0x64, 0x78, 0x5F, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6F, 0x6E, 0x00, 0x31, 0x2E, 0x37, 0x36, 0x64,
        0x00, 0x63, 0x6F, 0x6F, 0x70, 0x00, 0x30, 0x00, 0x63, 0x73, 0x64, 0x6D, 0x5F, 0x61, 0x63, 0x74,
        0x69, 0x76, 0x65, 0x00, 0x31, 0x00, 0x63, 0x73, 0x64, 0x6D, 0x5F, 0x76, 0x65, 0x72, 0x73, 0x69,
        0x6F, 0x6E, 0x00, 0x32, 0x2E, 0x31, 0x00, 0x64, 0x65, 0x61, 0x74, 0x68, 0x6D, 0x61, 0x74, 0x63,
        0x68, 0x00, 0x31, 0x00, 0x64, 0x65, 0x63, 0x61, 0x6C, 0x66, 0x72, 0x65, 0x71, 0x75, 0x65, 0x6E,
        0x63, 0x79, 0x00, 0x36, 0x30, 0x00, 0x65, 0x64, 0x67, 0x65, 0x66, 0x72, 0x69, 0x63, 0x74, 0x69,
        0x6F, 0x6E, 0x00, 0x32, 0x00, 0x68, 0x6F, 0x73, 0x74, 0x61, 0x67, 0x65, 0x5F, 0x64, 0x65, 0x62,
        0x75, 0x67, 0x00, 0x30, 0x00, 0x68, 0x6F, 0x73, 0x74, 0x61, 0x67, 0x65, 0x5F, 0x73, 0x74, 0x6F,
        0x70, 0x00, 0x30, 0x00, 0x68, 0x75, 0x6D, 0x61, 0x6E, 0x73, 0x5F, 0x6A, 0x6F, 0x69, 0x6E, 0x5F,
        0x74, 0x65, 0x61, 0x6D, 0x00, 0x61, 0x6E, 0x79, 0x00, 0x6A, 0x74, 0x70, 0x31, 0x30, 0x31, 0x38,
        0x31, 0x00, 0x63, 0x68, 0x75, 0x74, 0x65, 0x00, 0x6D, 0x61, 0x78, 0x5F, 0x71, 0x75, 0x65, 0x72,
        0x69, 0x65, 0x73, 0x5F, 0x73, 0x65, 0x63, 0x00, 0x31, 0x00, 0x6D, 0x61, 0x78, 0x5F, 0x71, 0x75,
        0x65, 0x72, 0x69, 0x65, 0x73, 0x5F, 0x73, 0x65, 0x63, 0x5F, 0x67, 0x6C, 0x6F, 0x62, 0x61, 0x6C,
        0x00, 0x31, 0x00, 0x6D, 0x61, 0x78, 0x5F, 0x71, 0x75, 0x65, 0x72, 0x69, 0x65, 0x73, 0x5F, 0x77,
        0x69, 0x6E, 0x64, 0x6F, 0x77, 0x00, 0x31, 0x00, 0x6D, 0x65, 0x74, 0x61, 0x6D, 0x6F, 0x64, 0x5F,
        0x76, 0x65, 0x72, 0x73, 0x69, 0x6F, 0x6E, 0x00, 0x31, 0x2E, 0x31, 0x39, 0x00, 0x6D, 0x70, 0x5F,
        0x61, 0x6C, 0x6C, 0x6F, 0x77, 0x6D, 0x6F, 0x6E, 0x73, 0x74, 0x65, 0x72, 0x73, 0x00, 0x30, 0x00,
        0x6D, 0x70, 0x5F, 0x61, 0x75, 0x74, 0x6F, 0x6B, 0x69, 0x63, 0x6B, 0x00, 0x30, 0x00, 0x6D, 0x70,
        0x5F, 0x61, 0x75, 0x74, 0x6F, 0x74, 0x65, 0x61, 0x6D, 0x62, 0x61, 0x6C, 0x61, 0x6E, 0x63, 0x65,
        0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x62, 0x75, 0x79, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x39, 0x39,
        0x39, 0x39, 0x00, 0x6D, 0x70, 0x5F, 0x63, 0x34, 0x74, 0x69, 0x6D, 0x65, 0x72, 0x00, 0x33, 0x35,
        0x00, 0x6D, 0x70, 0x5F, 0x63, 0x68, 0x61, 0x74, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x35, 0x00, 0x6D,
        0x70, 0x5F, 0x63, 0x6F, 0x6E, 0x73, 0x69, 0x73, 0x74, 0x65, 0x6E, 0x63, 0x79, 0x00, 0x31, 0x00,
        0x6D, 0x70, 0x5F, 0x66, 0x61, 0x64, 0x65, 0x74, 0x6F, 0x62, 0x6C, 0x61, 0x63, 0x6B, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x66, 0x6C, 0x61, 0x73, 0x68, 0x6C, 0x69, 0x67, 0x68, 0x74, 0x00, 0x31,
        0x00, 0x6D, 0x70, 0x5F, 0x66, 0x6F, 0x6F, 0x74, 0x73, 0x74, 0x65, 0x70, 0x73, 0x00, 0x31, 0x00,
        0x6D, 0x70, 0x5F, 0x66, 0x6F, 0x72, 0x63, 0x65, 0x63, 0x61, 0x6D, 0x65, 0x72, 0x61, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x66, 0x6F, 0x72, 0x63, 0x65, 0x63, 0x68, 0x61, 0x73, 0x65, 0x63, 0x61,
        0x6D, 0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x66, 0x72, 0x61, 0x67, 0x73, 0x6C, 0x65, 0x66, 0x74,
        0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x66, 0x72, 0x65, 0x65, 0x66, 0x6F, 0x72, 0x61, 0x6C, 0x6C,
        0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x66, 0x72, 0x65, 0x65, 0x7A, 0x65, 0x74, 0x69, 0x6D, 0x65,
        0x00, 0x32, 0x00, 0x6D, 0x70, 0x5F, 0x66, 0x72, 0x69, 0x65, 0x6E, 0x64, 0x6C, 0x79, 0x66, 0x69,
        0x72, 0x65, 0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x67, 0x68, 0x6F, 0x73, 0x74, 0x66, 0x72, 0x65,
        0x71, 0x75, 0x65, 0x6E, 0x63, 0x79, 0x00, 0x30, 0x2E, 0x31, 0x00, 0x6D, 0x70, 0x5F, 0x68, 0x6F,
        0x73, 0x74, 0x61, 0x67, 0x65, 0x70, 0x65, 0x6E, 0x61, 0x6C, 0x74, 0x79, 0x00, 0x31, 0x33, 0x00,
        0x6D, 0x70, 0x5F, 0x6B, 0x69, 0x63, 0x6B, 0x70, 0x65, 0x72, 0x63, 0x65, 0x6E, 0x74, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x6C, 0x69, 0x6D, 0x69, 0x74, 0x74, 0x65, 0x61, 0x6D, 0x73, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x6C, 0x6F, 0x67, 0x64, 0x65, 0x74, 0x61, 0x69, 0x6C, 0x00, 0x33, 0x00,
        0x6D, 0x70, 0x5F, 0x6C, 0x6F, 0x67, 0x66, 0x69, 0x6C, 0x65, 0x00, 0x31, 0x00, 0x6D, 0x70, 0x5F,
        0x6C, 0x6F, 0x67, 0x6D, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x73, 0x00, 0x31, 0x00, 0x6D, 0x70,
        0x5F, 0x6D, 0x61, 0x70, 0x76, 0x6F, 0x74, 0x65, 0x72, 0x61, 0x74, 0x69, 0x6F, 0x00, 0x31, 0x00,
        0x6D, 0x70, 0x5F, 0x6D, 0x61, 0x78, 0x72, 0x6F, 0x75, 0x6E, 0x64, 0x73, 0x00, 0x30, 0x00, 0x6D,
        0x70, 0x5F, 0x6D, 0x69, 0x72, 0x72, 0x6F, 0x72, 0x64, 0x61, 0x6D, 0x61, 0x67, 0x65, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x70, 0x6C, 0x61, 0x79, 0x65, 0x72, 0x69, 0x64, 0x00, 0x30, 0x00, 0x6D,
        0x70, 0x5F, 0x72, 0x6F, 0x75, 0x6E, 0x64, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x33, 0x00, 0x6D, 0x70,
        0x5F, 0x73, 0x74, 0x61, 0x72, 0x74, 0x6D, 0x6F, 0x6E, 0x65, 0x79, 0x00, 0x38, 0x30, 0x30, 0x00,
        0x6D, 0x70, 0x5F, 0x74, 0x69, 0x6D, 0x65, 0x6C, 0x65, 0x66, 0x74, 0x00, 0x30, 0x00, 0x6D, 0x70,
        0x5F, 0x74, 0x69, 0x6D, 0x65, 0x6C, 0x69, 0x6D, 0x69, 0x74, 0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F,
        0x74, 0x6B, 0x70, 0x75, 0x6E, 0x69, 0x73, 0x68, 0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x77, 0x69,
        0x6E, 0x64, 0x69, 0x66, 0x66, 0x65, 0x72, 0x65, 0x6E, 0x63, 0x65, 0x00, 0x31, 0x00, 0x6D, 0x70,
        0x5F, 0x77, 0x69, 0x6E, 0x6C, 0x69, 0x6D, 0x69, 0x74, 0x00, 0x30, 0x00, 0x70, 0x61, 0x75, 0x73,
        0x61, 0x62, 0x6C, 0x65, 0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x63, 0x63, 0x65, 0x6C, 0x65,
        0x72, 0x61, 0x74, 0x65, 0x00, 0x35, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x69, 0x6D, 0x00, 0x30, 0x00,
        0x73, 0x76, 0x5F, 0x61, 0x69, 0x72, 0x61, 0x63, 0x63, 0x65, 0x6C, 0x65, 0x72, 0x61, 0x74, 0x65,
        0x00, 0x31, 0x30, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x69, 0x72, 0x6D, 0x6F, 0x76, 0x65, 0x00,
        0x31, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x6C, 0x6C, 0x6F, 0x77, 0x75, 0x70, 0x6C, 0x6F, 0x61, 0x64,
        0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x6C, 0x6C, 0x74, 0x61, 0x6C, 0x6B, 0x00, 0x31, 0x00,
        0x73, 0x76, 0x5F, 0x62, 0x6F, 0x75, 0x6E, 0x63, 0x65, 0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x63,
        0x68, 0x65, 0x61, 0x74, 0x73, 0x00, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x63, 0x6C, 0x69, 0x65, 0x6E,
        0x74, 0x74, 0x72, 0x61, 0x63, 0x65, 0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x63, 0x6C, 0x69, 0x70,
        0x6D, 0x6F, 0x64, 0x65, 0x00, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x63, 0x6F, 0x6E, 0x74, 0x61, 0x63,
        0x74, 0x00, 0x00, 0x73, 0x76, 0x5F, 0x66, 0x72, 0x69, 0x63, 0x74, 0x69, 0x6F, 0x6E, 0x00, 0x34,
        0x00, 0x73, 0x76, 0x5F, 0x67, 0x72, 0x61, 0x76, 0x69, 0x74, 0x79, 0x00, 0x37, 0x35, 0x30, 0x00,
        0x73, 0x76, 0x5F, 0x6C, 0x6F, 0x67, 0x62, 0x6C, 0x6F, 0x63, 0x6B, 0x73, 0x00, 0x30, 0x00, 0x73,
        0x76, 0x5F, 0x6D, 0x61, 0x78, 0x72, 0x61, 0x74, 0x65, 0x00, 0x32, 0x35, 0x30, 0x30, 0x30, 0x00,
        0x73, 0x76, 0x5F, 0x6D, 0x61, 0x78, 0x73, 0x70, 0x65, 0x65, 0x64, 0x00, 0x33, 0x32, 0x30, 0x00,
        0x73, 0x76, 0x5F, 0x6D, 0x69, 0x6E, 0x72, 0x61, 0x74, 0x65, 0x00, 0x31, 0x35, 0x30, 0x30, 0x30,
        0x00, 0x73, 0x76, 0x5F, 0x70, 0x61, 0x73, 0x73, 0x77, 0x6F, 0x72, 0x64, 0x00, 0x30, 0x00, 0x73,
        0x76, 0x5F, 0x70, 0x72, 0x6F, 0x78, 0x69, 0x65, 0x73, 0x00, 0x32, 0x00, 0x73, 0x76, 0x5F, 0x72,
        0x65, 0x67, 0x69, 0x6F, 0x6E, 0x00, 0x33, 0x00, 0x73, 0x76, 0x5F, 0x72, 0x65, 0x73, 0x74, 0x61,
        0x72, 0x74, 0x00, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x72, 0x65, 0x73, 0x74, 0x61, 0x72, 0x74, 0x72,
        0x6F, 0x75, 0x6E, 0x64, 0x00, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x73, 0x74, 0x65, 0x70, 0x73, 0x69,
        0x7A, 0x65, 0x00, 0x31, 0x38, 0x00, 0x73, 0x76, 0x5F, 0x73, 0x74, 0x6F, 0x70, 0x73, 0x70, 0x65,
        0x65, 0x64, 0x00, 0x37, 0x35, 0x00, 0x73, 0x76, 0x5F, 0x75, 0x70, 0x6C, 0x6F, 0x61, 0x64, 0x6D,
        0x61, 0x78, 0x00, 0x30, 0x2E, 0x35, 0x00, 0x73, 0x76, 0x5F, 0x76, 0x6F, 0x69, 0x63, 0x65, 0x65,
        0x6E, 0x61, 0x62, 0x6C, 0x65, 0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x77, 0x61, 0x74, 0x65, 0x72,
        0x61, 0x63, 0x63, 0x65, 0x6C, 0x65, 0x72, 0x61, 0x74, 0x65, 0x00, 0x31, 0x30, 0x00, 0x73, 0x76,
        0x5F, 0x77, 0x61, 0x74, 0x65, 0x72, 0x66, 0x72, 0x69, 0x63, 0x74, 0x69, 0x6F, 0x6E, 0x00, 0x31,
        0x00
    };

    const size_t response_len = sizeof (response);

    cr_expect(ssq_response_istruncated(response, response_len));
}

Test(response, istruncated_no, .description = "Response was not truncated") {
    const char response[] = {
        0x49, 0x02, 0x67, 0x61, 0x6D, 0x65, 0x32, 0x78, 0x73, 0x2E, 0x63, 0x6F, 0x6D, 0x20, 0x43, 0x6F,
        0x75, 0x6E, 0x74, 0x65, 0x72, 0x2D, 0x53, 0x74, 0x72, 0x69, 0x6B, 0x65, 0x20, 0x53, 0x6F, 0x75,
        0x72, 0x63, 0x65, 0x20, 0x23, 0x31, 0x00, 0x64, 0x65, 0x5F, 0x64, 0x75, 0x73, 0x74, 0x00, 0x63,
        0x73, 0x74, 0x72, 0x69, 0x6B, 0x65, 0x00, 0x43, 0x6F, 0x75, 0x6E, 0x74, 0x65, 0x72, 0x2D, 0x53,
        0x74, 0x72, 0x69, 0x6B, 0x65, 0x3A, 0x20, 0x53, 0x6F, 0x75, 0x72, 0x63, 0x65, 0x00, 0xF0, 0x00,
        0x05, 0x10, 0x04, 0x64, 0x6C, 0x00, 0x00, 0x31, 0x2E, 0x30, 0x2E, 0x30, 0x2E, 0x32, 0x32, 0x00
    };

    const size_t response_len = sizeof (response);

    cr_expect(!ssq_response_istruncated(response, response_len));
}
