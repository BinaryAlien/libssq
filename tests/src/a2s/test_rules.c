#include <criterion/criterion.h>
#include "ssq/a2s/rules.h"

A2S_RULES *ssq_rules_deserialize(
    const char       response[],
    const size_t     response_len,
    uint16_t  *const rule_count,
    SSQ_ERROR *const err
);

static void helper_expect_rules_eq(const A2S_RULES *const actual, const char expected_name[], const char expected_value[]) {
    cr_expect_str_eq(actual->name,  expected_name);
    cr_expect_eq(actual->name_len,  strlen(expected_name));
    cr_expect_str_eq(actual->value, expected_value);
    cr_expect_eq(actual->value_len, strlen(expected_value));
}

Test(a2s_rules, wiki_example, .description = "Wiki Example") {
   const char response[] = {
        0xFF, 0xFF, 0xFF, 0xFF, 0x45, 0x5D, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x62, 0x6F,
        0x6D, 0x62, 0x5F, 0x76, 0x69, 0x65, 0x77, 0x61, 0x62, 0x6C, 0x65, 0x5F, 0x63, 0x68, 0x65, 0x63,
        0x6B, 0x5F, 0x69, 0x6E, 0x74, 0x65, 0x72, 0x76, 0x61, 0x6C, 0x00, 0x30, 0x2E, 0x35, 0x00, 0x5F,
        0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x64, 0x65, 0x62, 0x75, 0x67, 0x5F, 0x6C, 0x65, 0x76, 0x65,
        0x6C, 0x00, 0x30, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x65, 0x78, 0x61, 0x6D, 0x69,
        0x6E, 0x65, 0x5F, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x30, 0x2E, 0x35, 0x00, 0x5F, 0x74, 0x75, 0x74,
        0x6F, 0x72, 0x5F, 0x68, 0x69, 0x6E, 0x74, 0x5F, 0x69, 0x6E, 0x74, 0x65, 0x72, 0x76, 0x61, 0x6C,
        0x5F, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x31, 0x30, 0x2E, 0x30, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F,
        0x72, 0x5F, 0x6C, 0x6F, 0x6F, 0x6B, 0x5F, 0x61, 0x6E, 0x67, 0x6C, 0x65, 0x00, 0x31, 0x30, 0x00,
        0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x6C, 0x6F, 0x6F, 0x6B, 0x5F, 0x64, 0x69, 0x73, 0x74,
        0x61, 0x6E, 0x63, 0x65, 0x00, 0x32, 0x30, 0x30, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F,
        0x6D, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x5F, 0x63, 0x68, 0x61, 0x72, 0x61, 0x63, 0x74, 0x65,
        0x72, 0x5F, 0x64, 0x69, 0x73, 0x70, 0x6C, 0x61, 0x79, 0x5F, 0x74, 0x69, 0x6D, 0x65, 0x5F, 0x63,
        0x6F, 0x65, 0x66, 0x66, 0x69, 0x63, 0x69, 0x65, 0x6E, 0x74, 0x00, 0x30, 0x2E, 0x30, 0x37, 0x00,
        0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x6D, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x5F, 0x6D,
        0x69, 0x6E, 0x69, 0x6D, 0x75, 0x6D, 0x5F, 0x64, 0x69, 0x73, 0x70, 0x6C, 0x61, 0x79, 0x5F, 0x74,
        0x69, 0x6D, 0x65, 0x00, 0x31, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x6D, 0x65, 0x73,
        0x73, 0x61, 0x67, 0x65, 0x5F, 0x72, 0x65, 0x70, 0x65, 0x61, 0x74, 0x73, 0x00, 0x35, 0x00, 0x5F,
        0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x76, 0x69, 0x65, 0x77, 0x5F, 0x64, 0x69, 0x73, 0x74, 0x61,
        0x6E, 0x63, 0x65, 0x00, 0x31, 0x30, 0x30, 0x30, 0x00, 0x61, 0x6C, 0x6C, 0x6F, 0x77, 0x5F, 0x73,
        0x70, 0x65, 0x63, 0x74, 0x61, 0x74, 0x6F, 0x72, 0x73, 0x00, 0x31, 0x00, 0x61, 0x6D, 0x78, 0x5F,
        0x63, 0x6C, 0x69, 0x65, 0x6E, 0x74, 0x5F, 0x6C, 0x61, 0x6E, 0x67, 0x75, 0x61, 0x67, 0x65, 0x73,
        0x00, 0x31, 0x00, 0x61, 0x6D, 0x78, 0x5F, 0x6C, 0x61, 0x6E, 0x67, 0x75, 0x61, 0x67, 0x65, 0x00,
        0x66, 0x72, 0x00, 0x61, 0x6D, 0x78, 0x5F, 0x6E, 0x65, 0x78, 0x74, 0x6D, 0x61, 0x70, 0x00, 0x64,
        0x65, 0x5F, 0x61, 0x7A, 0x74, 0x65, 0x63, 0x00, 0x61, 0x6D, 0x78, 0x5F, 0x74, 0x69, 0x6D, 0x65,
        0x6C, 0x65, 0x66, 0x74, 0x00, 0x30, 0x30, 0x3A, 0x30, 0x30, 0x00, 0x61, 0x6D, 0x78, 0x6D, 0x6F,
        0x64, 0x78, 0x5F, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6F, 0x6E, 0x00, 0x31, 0x2E, 0x37, 0x36, 0x64,
        0x00, 0x63, 0x6F, 0x6F, 0x70, 0x00, 0x30, 0x00, 0x63, 0x73, 0x64, 0x6D, 0x5F, 0x61, 0x63, 0x74,
        0x69, 0x76, 0x65, 0x00, 0x31, 0x00, 0x63, 0x73, 0x64, 0x6D, 0x5F, 0x76, 0x65, 0x72, 0x73, 0x69,
        0x6F, 0x6E, 0x00, 0x32, 0x2E, 0x31, 0x00, 0x64, 0x65, 0x61, 0x74, 0x68, 0x6D, 0x61, 0x74, 0x63,
        0x68, 0x00, 0x31, 0x00, 0x64, 0x65, 0x63, 0x61, 0x6C, 0x66, 0x72, 0x65, 0x71, 0x75, 0x65, 0x6E,
        0x63, 0x79, 0x00, 0x36, 0x30, 0x00, 0x65, 0x64, 0x67, 0x65, 0x66, 0x72, 0x69, 0x63, 0x74, 0x69,
        0x6F, 0x6E, 0x00, 0x32, 0x00, 0x68, 0x6F, 0x73, 0x74, 0x61, 0x67, 0x65, 0x5F, 0x64, 0x65, 0x62,
        0x75, 0x67, 0x00, 0x30, 0x00, 0x68, 0x6F, 0x73, 0x74, 0x61, 0x67, 0x65, 0x5F, 0x73, 0x74, 0x6F,
        0x70, 0x00, 0x30, 0x00, 0x68, 0x75, 0x6D, 0x61, 0x6E, 0x73, 0x5F, 0x6A, 0x6F, 0x69, 0x6E, 0x5F,
        0x74, 0x65, 0x61, 0x6D, 0x00, 0x61, 0x6E, 0x79, 0x00, 0x6A, 0x74, 0x70, 0x31, 0x30, 0x31, 0x38,
        0x31, 0x00, 0x63, 0x68, 0x75, 0x74, 0x65, 0x00, 0x6D, 0x61, 0x78, 0x5F, 0x71, 0x75, 0x65, 0x72,
        0x69, 0x65, 0x73, 0x5F, 0x73, 0x65, 0x63, 0x00, 0x31, 0x00, 0x6D, 0x61, 0x78, 0x5F, 0x71, 0x75,
        0x65, 0x72, 0x69, 0x65, 0x73, 0x5F, 0x73, 0x65, 0x63, 0x5F, 0x67, 0x6C, 0x6F, 0x62, 0x61, 0x6C,
        0x00, 0x31, 0x00, 0x6D, 0x61, 0x78, 0x5F, 0x71, 0x75, 0x65, 0x72, 0x69, 0x65, 0x73, 0x5F, 0x77,
        0x69, 0x6E, 0x64, 0x6F, 0x77, 0x00, 0x31, 0x00, 0x6D, 0x65, 0x74, 0x61, 0x6D, 0x6F, 0x64, 0x5F,
        0x76, 0x65, 0x72, 0x73, 0x69, 0x6F, 0x6E, 0x00, 0x31, 0x2E, 0x31, 0x39, 0x00, 0x6D, 0x70, 0x5F,
        0x61, 0x6C, 0x6C, 0x6F, 0x77, 0x6D, 0x6F, 0x6E, 0x73, 0x74, 0x65, 0x72, 0x73, 0x00, 0x30, 0x00,
        0x6D, 0x70, 0x5F, 0x61, 0x75, 0x74, 0x6F, 0x6B, 0x69, 0x63, 0x6B, 0x00, 0x30, 0x00, 0x6D, 0x70,
        0x5F, 0x61, 0x75, 0x74, 0x6F, 0x74, 0x65, 0x61, 0x6D, 0x62, 0x61, 0x6C, 0x61, 0x6E, 0x63, 0x65,
        0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x62, 0x75, 0x79, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x39, 0x39,
        0x39, 0x39, 0x00, 0x6D, 0x70, 0x5F, 0x63, 0x34, 0x74, 0x69, 0x6D, 0x65, 0x72, 0x00, 0x33, 0x35,
        0x00, 0x6D, 0x70, 0x5F, 0x63, 0x68, 0x61, 0x74, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x35, 0x00, 0x6D,
        0x70, 0x5F, 0x63, 0x6F, 0x6E, 0x73, 0x69, 0x73, 0x74, 0x65, 0x6E, 0x63, 0x79, 0x00, 0x31, 0x00,
        0x6D, 0x70, 0x5F, 0x66, 0x61, 0x64, 0x65, 0x74, 0x6F, 0x62, 0x6C, 0x61, 0x63, 0x6B, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x66, 0x6C, 0x61, 0x73, 0x68, 0x6C, 0x69, 0x67, 0x68, 0x74, 0x00, 0x31,
        0x00, 0x6D, 0x70, 0x5F, 0x66, 0x6F, 0x6F, 0x74, 0x73, 0x74, 0x65, 0x70, 0x73, 0x00, 0x31, 0x00,
        0x6D, 0x70, 0x5F, 0x66, 0x6F, 0x72, 0x63, 0x65, 0x63, 0x61, 0x6D, 0x65, 0x72, 0x61, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x66, 0x6F, 0x72, 0x63, 0x65, 0x63, 0x68, 0x61, 0x73, 0x65, 0x63, 0x61,
        0x6D, 0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x66, 0x72, 0x61, 0x67, 0x73, 0x6C, 0x65, 0x66, 0x74,
        0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x66, 0x72, 0x65, 0x65, 0x66, 0x6F, 0x72, 0x61, 0x6C, 0x6C,
        0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x66, 0x72, 0x65, 0x65, 0x7A, 0x65, 0x74, 0x69, 0x6D, 0x65,
        0x00, 0x32, 0x00, 0x6D, 0x70, 0x5F, 0x66, 0x72, 0x69, 0x65, 0x6E, 0x64, 0x6C, 0x79, 0x66, 0x69,
        0x72, 0x65, 0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x67, 0x68, 0x6F, 0x73, 0x74, 0x66, 0x72, 0x65,
        0x71, 0x75, 0x65, 0x6E, 0x63, 0x79, 0x00, 0x30, 0x2E, 0x31, 0x00, 0x6D, 0x70, 0x5F, 0x68, 0x6F,
        0x73, 0x74, 0x61, 0x67, 0x65, 0x70, 0x65, 0x6E, 0x61, 0x6C, 0x74, 0x79, 0x00, 0x31, 0x33, 0x00,
        0x6D, 0x70, 0x5F, 0x6B, 0x69, 0x63, 0x6B, 0x70, 0x65, 0x72, 0x63, 0x65, 0x6E, 0x74, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x6C, 0x69, 0x6D, 0x69, 0x74, 0x74, 0x65, 0x61, 0x6D, 0x73, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x6C, 0x6F, 0x67, 0x64, 0x65, 0x74, 0x61, 0x69, 0x6C, 0x00, 0x33, 0x00,
        0x6D, 0x70, 0x5F, 0x6C, 0x6F, 0x67, 0x66, 0x69, 0x6C, 0x65, 0x00, 0x31, 0x00, 0x6D, 0x70, 0x5F,
        0x6C, 0x6F, 0x67, 0x6D, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x73, 0x00, 0x31, 0x00, 0x6D, 0x70,
        0x5F, 0x6D, 0x61, 0x70, 0x76, 0x6F, 0x74, 0x65, 0x72, 0x61, 0x74, 0x69, 0x6F, 0x00, 0x31, 0x00,
        0x6D, 0x70, 0x5F, 0x6D, 0x61, 0x78, 0x72, 0x6F, 0x75, 0x6E, 0x64, 0x73, 0x00, 0x30, 0x00, 0x6D,
        0x70, 0x5F, 0x6D, 0x69, 0x72, 0x72, 0x6F, 0x72, 0x64, 0x61, 0x6D, 0x61, 0x67, 0x65, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x70, 0x6C, 0x61, 0x79, 0x65, 0x72, 0x69, 0x64, 0x00, 0x30, 0x00, 0x6D,
        0x70, 0x5F, 0x72, 0x6F, 0x75, 0x6E, 0x64, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x33, 0x00, 0x6D, 0x70,
        0x5F, 0x73, 0x74, 0x61, 0x72, 0x74, 0x6D, 0x6F, 0x6E, 0x65, 0x79, 0x00, 0x38, 0x30, 0x30, 0x00,
        0x6D, 0x70, 0x5F, 0x74, 0x69, 0x6D, 0x65, 0x6C, 0x65, 0x66, 0x74, 0x00, 0x30, 0x00, 0x6D, 0x70,
        0x5F, 0x74, 0x69, 0x6D, 0x65, 0x6C, 0x69, 0x6D, 0x69, 0x74, 0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F,
        0x74, 0x6B, 0x70, 0x75, 0x6E, 0x69, 0x73, 0x68, 0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x77, 0x69,
        0x6E, 0x64, 0x69, 0x66, 0x66, 0x65, 0x72, 0x65, 0x6E, 0x63, 0x65, 0x00, 0x31, 0x00, 0x6D, 0x70,
        0x5F, 0x77, 0x69, 0x6E, 0x6C, 0x69, 0x6D, 0x69, 0x74, 0x00, 0x30, 0x00, 0x70, 0x61, 0x75, 0x73,
        0x61, 0x62, 0x6C, 0x65, 0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x63, 0x63, 0x65, 0x6C, 0x65,
        0x72, 0x61, 0x74, 0x65, 0x00, 0x35, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x69, 0x6D, 0x00, 0x30, 0x00,
        0x73, 0x76, 0x5F, 0x61, 0x69, 0x72, 0x61, 0x63, 0x63, 0x65, 0x6C, 0x65, 0x72, 0x61, 0x74, 0x65,
        0x00, 0x31, 0x30, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x69, 0x72, 0x6D, 0x6F, 0x76, 0x65, 0x00,
        0x31, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x6C, 0x6C, 0x6F, 0x77, 0x75, 0x70, 0x6C, 0x6F, 0x61, 0x64,
        0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x6C, 0x6C, 0x74, 0x61, 0x6C, 0x6B, 0x00, 0x31, 0x00,
        0x73, 0x76, 0x5F, 0x62, 0x6F, 0x75, 0x6E, 0x63, 0x65, 0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x63,
        0x68, 0x65, 0x61, 0x74, 0x73, 0x00, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x63, 0x6C, 0x69, 0x65, 0x6E,
        0x74, 0x74, 0x72, 0x61, 0x63, 0x65, 0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x63, 0x6C, 0x69, 0x70,
        0x6D, 0x6F, 0x64, 0x65, 0x00, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x63, 0x6F, 0x6E, 0x74, 0x61, 0x63,
        0x74, 0x00, 0x00, 0x73, 0x76, 0x5F, 0x66, 0x72, 0x69, 0x63, 0x74, 0x69, 0x6F, 0x6E, 0x00, 0x34,
        0x00, 0x73, 0x76, 0x5F, 0x67, 0x72, 0x61, 0x76, 0x69, 0x74, 0x79, 0x00, 0x37, 0x35, 0x30, 0x00,
        0x73, 0x76, 0x5F, 0x6C, 0x6F, 0x67, 0x62, 0x6C, 0x6F, 0x63, 0x6B, 0x73, 0x00, 0x30, 0x00, 0x73,
        0x76, 0x5F, 0x6D, 0x61, 0x78, 0x72, 0x61, 0x74, 0x65, 0x00, 0x32, 0x35, 0x30, 0x30, 0x30, 0x00,
        0x73, 0x76, 0x5F, 0x6D, 0x61, 0x78, 0x73, 0x70, 0x65, 0x65, 0x64, 0x00, 0x33, 0x32, 0x30, 0x00,
        0x73, 0x76, 0x5F, 0x6D, 0x69, 0x6E, 0x72, 0x61, 0x74, 0x65, 0x00, 0x31, 0x35, 0x30, 0x30, 0x30,
        0x00, 0x73, 0x76, 0x5F, 0x70, 0x61, 0x73, 0x73, 0x77, 0x6F, 0x72, 0x64, 0x00, 0x30, 0x00, 0x73,
        0x76, 0x5F, 0x70, 0x72, 0x6F, 0x78, 0x69, 0x65, 0x73, 0x00, 0x32, 0x00, 0x73, 0x76, 0x5F, 0x72,
        0x65, 0x67, 0x69, 0x6F, 0x6E, 0x00, 0x33, 0x00, 0x73, 0x76, 0x5F, 0x72, 0x65, 0x73, 0x74, 0x61,
        0x72, 0x74, 0x00, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x72, 0x65, 0x73, 0x74, 0x61, 0x72, 0x74, 0x72,
        0x6F, 0x75, 0x6E, 0x64, 0x00, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x73, 0x74, 0x65, 0x70, 0x73, 0x69,
        0x7A, 0x65, 0x00, 0x31, 0x38, 0x00, 0x73, 0x76, 0x5F, 0x73, 0x74, 0x6F, 0x70, 0x73, 0x70, 0x65,
        0x65, 0x64, 0x00, 0x37, 0x35, 0x00, 0x73, 0x76, 0x5F, 0x75, 0x70, 0x6C, 0x6F, 0x61, 0x64, 0x6D,
        0x61, 0x78, 0x00, 0x30, 0x2E, 0x35, 0x00, 0x73, 0x76, 0x5F, 0x76, 0x6F, 0x69, 0x63, 0x65, 0x65,
        0x6E, 0x61, 0x62, 0x6C, 0x65, 0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x77, 0x61, 0x74, 0x65, 0x72,
        0x61, 0x63, 0x63, 0x65, 0x6C, 0x65, 0x72, 0x61, 0x74, 0x65, 0x00, 0x31, 0x30, 0x00, 0x73, 0x76,
        0x5F, 0x77, 0x61, 0x74, 0x65, 0x72, 0x66, 0x72, 0x69, 0x63, 0x74, 0x69, 0x6F, 0x6E, 0x00, 0x31,
        0x00
    };

    const size_t response_len = sizeof (response);

    SSQ_ERROR err;
    ssq_error_clear(&err);

    uint16_t         rule_count = 0;
    A2S_RULES *const rules      = ssq_rules_deserialize(response, response_len, &rule_count, &err);

    cr_assert_eq(err.code, SSQ_OK);
    cr_assert_eq(rule_count, 93);
    cr_assert_neq(rules, NULL);

    helper_expect_rules_eq(rules + 0, "_tutor_bomb_viewable_check_interval", "0.5");
    helper_expect_rules_eq(rules + 1, "_tutor_debug_level",                  "0");
    helper_expect_rules_eq(rules + 2, "_tutor_examine_time",                 "0.5");
    helper_expect_rules_eq(rules + 3, "_tutor_hint_interval_time",           "10.0");

    // ...

    helper_expect_rules_eq(rules + rule_count - 1, "sv_waterfriction",       "1");

    ssq_rules_free(rules, rule_count);

}

Test(a2s_rules, bad_header, .description = "Invalid response header") {
    const uint8_t bad_header = 0x00;

   const char response[] = {
        0xFF, 0xFF, 0xFF, 0xFF, bad_header, 0x5D, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x62, 0x6F,
        0x6D, 0x62, 0x5F, 0x76, 0x69, 0x65, 0x77, 0x61, 0x62, 0x6C, 0x65, 0x5F, 0x63, 0x68, 0x65, 0x63,
        0x6B, 0x5F, 0x69, 0x6E, 0x74, 0x65, 0x72, 0x76, 0x61, 0x6C, 0x00, 0x30, 0x2E, 0x35, 0x00, 0x5F,
        0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x64, 0x65, 0x62, 0x75, 0x67, 0x5F, 0x6C, 0x65, 0x76, 0x65,
        0x6C, 0x00, 0x30, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x65, 0x78, 0x61, 0x6D, 0x69,
        0x6E, 0x65, 0x5F, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x30, 0x2E, 0x35, 0x00, 0x5F, 0x74, 0x75, 0x74,
        0x6F, 0x72, 0x5F, 0x68, 0x69, 0x6E, 0x74, 0x5F, 0x69, 0x6E, 0x74, 0x65, 0x72, 0x76, 0x61, 0x6C,
        0x5F, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x31, 0x30, 0x2E, 0x30, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F,
        0x72, 0x5F, 0x6C, 0x6F, 0x6F, 0x6B, 0x5F, 0x61, 0x6E, 0x67, 0x6C, 0x65, 0x00, 0x31, 0x30, 0x00,
        0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x6C, 0x6F, 0x6F, 0x6B, 0x5F, 0x64, 0x69, 0x73, 0x74,
        0x61, 0x6E, 0x63, 0x65, 0x00, 0x32, 0x30, 0x30, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F,
        0x6D, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x5F, 0x63, 0x68, 0x61, 0x72, 0x61, 0x63, 0x74, 0x65,
        0x72, 0x5F, 0x64, 0x69, 0x73, 0x70, 0x6C, 0x61, 0x79, 0x5F, 0x74, 0x69, 0x6D, 0x65, 0x5F, 0x63,
        0x6F, 0x65, 0x66, 0x66, 0x69, 0x63, 0x69, 0x65, 0x6E, 0x74, 0x00, 0x30, 0x2E, 0x30, 0x37, 0x00,
        0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x6D, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x5F, 0x6D,
        0x69, 0x6E, 0x69, 0x6D, 0x75, 0x6D, 0x5F, 0x64, 0x69, 0x73, 0x70, 0x6C, 0x61, 0x79, 0x5F, 0x74,
        0x69, 0x6D, 0x65, 0x00, 0x31, 0x00, 0x5F, 0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x6D, 0x65, 0x73,
        0x73, 0x61, 0x67, 0x65, 0x5F, 0x72, 0x65, 0x70, 0x65, 0x61, 0x74, 0x73, 0x00, 0x35, 0x00, 0x5F,
        0x74, 0x75, 0x74, 0x6F, 0x72, 0x5F, 0x76, 0x69, 0x65, 0x77, 0x5F, 0x64, 0x69, 0x73, 0x74, 0x61,
        0x6E, 0x63, 0x65, 0x00, 0x31, 0x30, 0x30, 0x30, 0x00, 0x61, 0x6C, 0x6C, 0x6F, 0x77, 0x5F, 0x73,
        0x70, 0x65, 0x63, 0x74, 0x61, 0x74, 0x6F, 0x72, 0x73, 0x00, 0x31, 0x00, 0x61, 0x6D, 0x78, 0x5F,
        0x63, 0x6C, 0x69, 0x65, 0x6E, 0x74, 0x5F, 0x6C, 0x61, 0x6E, 0x67, 0x75, 0x61, 0x67, 0x65, 0x73,
        0x00, 0x31, 0x00, 0x61, 0x6D, 0x78, 0x5F, 0x6C, 0x61, 0x6E, 0x67, 0x75, 0x61, 0x67, 0x65, 0x00,
        0x66, 0x72, 0x00, 0x61, 0x6D, 0x78, 0x5F, 0x6E, 0x65, 0x78, 0x74, 0x6D, 0x61, 0x70, 0x00, 0x64,
        0x65, 0x5F, 0x61, 0x7A, 0x74, 0x65, 0x63, 0x00, 0x61, 0x6D, 0x78, 0x5F, 0x74, 0x69, 0x6D, 0x65,
        0x6C, 0x65, 0x66, 0x74, 0x00, 0x30, 0x30, 0x3A, 0x30, 0x30, 0x00, 0x61, 0x6D, 0x78, 0x6D, 0x6F,
        0x64, 0x78, 0x5F, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6F, 0x6E, 0x00, 0x31, 0x2E, 0x37, 0x36, 0x64,
        0x00, 0x63, 0x6F, 0x6F, 0x70, 0x00, 0x30, 0x00, 0x63, 0x73, 0x64, 0x6D, 0x5F, 0x61, 0x63, 0x74,
        0x69, 0x76, 0x65, 0x00, 0x31, 0x00, 0x63, 0x73, 0x64, 0x6D, 0x5F, 0x76, 0x65, 0x72, 0x73, 0x69,
        0x6F, 0x6E, 0x00, 0x32, 0x2E, 0x31, 0x00, 0x64, 0x65, 0x61, 0x74, 0x68, 0x6D, 0x61, 0x74, 0x63,
        0x68, 0x00, 0x31, 0x00, 0x64, 0x65, 0x63, 0x61, 0x6C, 0x66, 0x72, 0x65, 0x71, 0x75, 0x65, 0x6E,
        0x63, 0x79, 0x00, 0x36, 0x30, 0x00, 0x65, 0x64, 0x67, 0x65, 0x66, 0x72, 0x69, 0x63, 0x74, 0x69,
        0x6F, 0x6E, 0x00, 0x32, 0x00, 0x68, 0x6F, 0x73, 0x74, 0x61, 0x67, 0x65, 0x5F, 0x64, 0x65, 0x62,
        0x75, 0x67, 0x00, 0x30, 0x00, 0x68, 0x6F, 0x73, 0x74, 0x61, 0x67, 0x65, 0x5F, 0x73, 0x74, 0x6F,
        0x70, 0x00, 0x30, 0x00, 0x68, 0x75, 0x6D, 0x61, 0x6E, 0x73, 0x5F, 0x6A, 0x6F, 0x69, 0x6E, 0x5F,
        0x74, 0x65, 0x61, 0x6D, 0x00, 0x61, 0x6E, 0x79, 0x00, 0x6A, 0x74, 0x70, 0x31, 0x30, 0x31, 0x38,
        0x31, 0x00, 0x63, 0x68, 0x75, 0x74, 0x65, 0x00, 0x6D, 0x61, 0x78, 0x5F, 0x71, 0x75, 0x65, 0x72,
        0x69, 0x65, 0x73, 0x5F, 0x73, 0x65, 0x63, 0x00, 0x31, 0x00, 0x6D, 0x61, 0x78, 0x5F, 0x71, 0x75,
        0x65, 0x72, 0x69, 0x65, 0x73, 0x5F, 0x73, 0x65, 0x63, 0x5F, 0x67, 0x6C, 0x6F, 0x62, 0x61, 0x6C,
        0x00, 0x31, 0x00, 0x6D, 0x61, 0x78, 0x5F, 0x71, 0x75, 0x65, 0x72, 0x69, 0x65, 0x73, 0x5F, 0x77,
        0x69, 0x6E, 0x64, 0x6F, 0x77, 0x00, 0x31, 0x00, 0x6D, 0x65, 0x74, 0x61, 0x6D, 0x6F, 0x64, 0x5F,
        0x76, 0x65, 0x72, 0x73, 0x69, 0x6F, 0x6E, 0x00, 0x31, 0x2E, 0x31, 0x39, 0x00, 0x6D, 0x70, 0x5F,
        0x61, 0x6C, 0x6C, 0x6F, 0x77, 0x6D, 0x6F, 0x6E, 0x73, 0x74, 0x65, 0x72, 0x73, 0x00, 0x30, 0x00,
        0x6D, 0x70, 0x5F, 0x61, 0x75, 0x74, 0x6F, 0x6B, 0x69, 0x63, 0x6B, 0x00, 0x30, 0x00, 0x6D, 0x70,
        0x5F, 0x61, 0x75, 0x74, 0x6F, 0x74, 0x65, 0x61, 0x6D, 0x62, 0x61, 0x6C, 0x61, 0x6E, 0x63, 0x65,
        0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x62, 0x75, 0x79, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x39, 0x39,
        0x39, 0x39, 0x00, 0x6D, 0x70, 0x5F, 0x63, 0x34, 0x74, 0x69, 0x6D, 0x65, 0x72, 0x00, 0x33, 0x35,
        0x00, 0x6D, 0x70, 0x5F, 0x63, 0x68, 0x61, 0x74, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x35, 0x00, 0x6D,
        0x70, 0x5F, 0x63, 0x6F, 0x6E, 0x73, 0x69, 0x73, 0x74, 0x65, 0x6E, 0x63, 0x79, 0x00, 0x31, 0x00,
        0x6D, 0x70, 0x5F, 0x66, 0x61, 0x64, 0x65, 0x74, 0x6F, 0x62, 0x6C, 0x61, 0x63, 0x6B, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x66, 0x6C, 0x61, 0x73, 0x68, 0x6C, 0x69, 0x67, 0x68, 0x74, 0x00, 0x31,
        0x00, 0x6D, 0x70, 0x5F, 0x66, 0x6F, 0x6F, 0x74, 0x73, 0x74, 0x65, 0x70, 0x73, 0x00, 0x31, 0x00,
        0x6D, 0x70, 0x5F, 0x66, 0x6F, 0x72, 0x63, 0x65, 0x63, 0x61, 0x6D, 0x65, 0x72, 0x61, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x66, 0x6F, 0x72, 0x63, 0x65, 0x63, 0x68, 0x61, 0x73, 0x65, 0x63, 0x61,
        0x6D, 0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x66, 0x72, 0x61, 0x67, 0x73, 0x6C, 0x65, 0x66, 0x74,
        0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x66, 0x72, 0x65, 0x65, 0x66, 0x6F, 0x72, 0x61, 0x6C, 0x6C,
        0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x66, 0x72, 0x65, 0x65, 0x7A, 0x65, 0x74, 0x69, 0x6D, 0x65,
        0x00, 0x32, 0x00, 0x6D, 0x70, 0x5F, 0x66, 0x72, 0x69, 0x65, 0x6E, 0x64, 0x6C, 0x79, 0x66, 0x69,
        0x72, 0x65, 0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x67, 0x68, 0x6F, 0x73, 0x74, 0x66, 0x72, 0x65,
        0x71, 0x75, 0x65, 0x6E, 0x63, 0x79, 0x00, 0x30, 0x2E, 0x31, 0x00, 0x6D, 0x70, 0x5F, 0x68, 0x6F,
        0x73, 0x74, 0x61, 0x67, 0x65, 0x70, 0x65, 0x6E, 0x61, 0x6C, 0x74, 0x79, 0x00, 0x31, 0x33, 0x00,
        0x6D, 0x70, 0x5F, 0x6B, 0x69, 0x63, 0x6B, 0x70, 0x65, 0x72, 0x63, 0x65, 0x6E, 0x74, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x6C, 0x69, 0x6D, 0x69, 0x74, 0x74, 0x65, 0x61, 0x6D, 0x73, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x6C, 0x6F, 0x67, 0x64, 0x65, 0x74, 0x61, 0x69, 0x6C, 0x00, 0x33, 0x00,
        0x6D, 0x70, 0x5F, 0x6C, 0x6F, 0x67, 0x66, 0x69, 0x6C, 0x65, 0x00, 0x31, 0x00, 0x6D, 0x70, 0x5F,
        0x6C, 0x6F, 0x67, 0x6D, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x73, 0x00, 0x31, 0x00, 0x6D, 0x70,
        0x5F, 0x6D, 0x61, 0x70, 0x76, 0x6F, 0x74, 0x65, 0x72, 0x61, 0x74, 0x69, 0x6F, 0x00, 0x31, 0x00,
        0x6D, 0x70, 0x5F, 0x6D, 0x61, 0x78, 0x72, 0x6F, 0x75, 0x6E, 0x64, 0x73, 0x00, 0x30, 0x00, 0x6D,
        0x70, 0x5F, 0x6D, 0x69, 0x72, 0x72, 0x6F, 0x72, 0x64, 0x61, 0x6D, 0x61, 0x67, 0x65, 0x00, 0x30,
        0x00, 0x6D, 0x70, 0x5F, 0x70, 0x6C, 0x61, 0x79, 0x65, 0x72, 0x69, 0x64, 0x00, 0x30, 0x00, 0x6D,
        0x70, 0x5F, 0x72, 0x6F, 0x75, 0x6E, 0x64, 0x74, 0x69, 0x6D, 0x65, 0x00, 0x33, 0x00, 0x6D, 0x70,
        0x5F, 0x73, 0x74, 0x61, 0x72, 0x74, 0x6D, 0x6F, 0x6E, 0x65, 0x79, 0x00, 0x38, 0x30, 0x30, 0x00,
        0x6D, 0x70, 0x5F, 0x74, 0x69, 0x6D, 0x65, 0x6C, 0x65, 0x66, 0x74, 0x00, 0x30, 0x00, 0x6D, 0x70,
        0x5F, 0x74, 0x69, 0x6D, 0x65, 0x6C, 0x69, 0x6D, 0x69, 0x74, 0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F,
        0x74, 0x6B, 0x70, 0x75, 0x6E, 0x69, 0x73, 0x68, 0x00, 0x30, 0x00, 0x6D, 0x70, 0x5F, 0x77, 0x69,
        0x6E, 0x64, 0x69, 0x66, 0x66, 0x65, 0x72, 0x65, 0x6E, 0x63, 0x65, 0x00, 0x31, 0x00, 0x6D, 0x70,
        0x5F, 0x77, 0x69, 0x6E, 0x6C, 0x69, 0x6D, 0x69, 0x74, 0x00, 0x30, 0x00, 0x70, 0x61, 0x75, 0x73,
        0x61, 0x62, 0x6C, 0x65, 0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x63, 0x63, 0x65, 0x6C, 0x65,
        0x72, 0x61, 0x74, 0x65, 0x00, 0x35, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x69, 0x6D, 0x00, 0x30, 0x00,
        0x73, 0x76, 0x5F, 0x61, 0x69, 0x72, 0x61, 0x63, 0x63, 0x65, 0x6C, 0x65, 0x72, 0x61, 0x74, 0x65,
        0x00, 0x31, 0x30, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x69, 0x72, 0x6D, 0x6F, 0x76, 0x65, 0x00,
        0x31, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x6C, 0x6C, 0x6F, 0x77, 0x75, 0x70, 0x6C, 0x6F, 0x61, 0x64,
        0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x61, 0x6C, 0x6C, 0x74, 0x61, 0x6C, 0x6B, 0x00, 0x31, 0x00,
        0x73, 0x76, 0x5F, 0x62, 0x6F, 0x75, 0x6E, 0x63, 0x65, 0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x63,
        0x68, 0x65, 0x61, 0x74, 0x73, 0x00, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x63, 0x6C, 0x69, 0x65, 0x6E,
        0x74, 0x74, 0x72, 0x61, 0x63, 0x65, 0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x63, 0x6C, 0x69, 0x70,
        0x6D, 0x6F, 0x64, 0x65, 0x00, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x63, 0x6F, 0x6E, 0x74, 0x61, 0x63,
        0x74, 0x00, 0x00, 0x73, 0x76, 0x5F, 0x66, 0x72, 0x69, 0x63, 0x74, 0x69, 0x6F, 0x6E, 0x00, 0x34,
        0x00, 0x73, 0x76, 0x5F, 0x67, 0x72, 0x61, 0x76, 0x69, 0x74, 0x79, 0x00, 0x37, 0x35, 0x30, 0x00,
        0x73, 0x76, 0x5F, 0x6C, 0x6F, 0x67, 0x62, 0x6C, 0x6F, 0x63, 0x6B, 0x73, 0x00, 0x30, 0x00, 0x73,
        0x76, 0x5F, 0x6D, 0x61, 0x78, 0x72, 0x61, 0x74, 0x65, 0x00, 0x32, 0x35, 0x30, 0x30, 0x30, 0x00,
        0x73, 0x76, 0x5F, 0x6D, 0x61, 0x78, 0x73, 0x70, 0x65, 0x65, 0x64, 0x00, 0x33, 0x32, 0x30, 0x00,
        0x73, 0x76, 0x5F, 0x6D, 0x69, 0x6E, 0x72, 0x61, 0x74, 0x65, 0x00, 0x31, 0x35, 0x30, 0x30, 0x30,
        0x00, 0x73, 0x76, 0x5F, 0x70, 0x61, 0x73, 0x73, 0x77, 0x6F, 0x72, 0x64, 0x00, 0x30, 0x00, 0x73,
        0x76, 0x5F, 0x70, 0x72, 0x6F, 0x78, 0x69, 0x65, 0x73, 0x00, 0x32, 0x00, 0x73, 0x76, 0x5F, 0x72,
        0x65, 0x67, 0x69, 0x6F, 0x6E, 0x00, 0x33, 0x00, 0x73, 0x76, 0x5F, 0x72, 0x65, 0x73, 0x74, 0x61,
        0x72, 0x74, 0x00, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x72, 0x65, 0x73, 0x74, 0x61, 0x72, 0x74, 0x72,
        0x6F, 0x75, 0x6E, 0x64, 0x00, 0x30, 0x00, 0x73, 0x76, 0x5F, 0x73, 0x74, 0x65, 0x70, 0x73, 0x69,
        0x7A, 0x65, 0x00, 0x31, 0x38, 0x00, 0x73, 0x76, 0x5F, 0x73, 0x74, 0x6F, 0x70, 0x73, 0x70, 0x65,
        0x65, 0x64, 0x00, 0x37, 0x35, 0x00, 0x73, 0x76, 0x5F, 0x75, 0x70, 0x6C, 0x6F, 0x61, 0x64, 0x6D,
        0x61, 0x78, 0x00, 0x30, 0x2E, 0x35, 0x00, 0x73, 0x76, 0x5F, 0x76, 0x6F, 0x69, 0x63, 0x65, 0x65,
        0x6E, 0x61, 0x62, 0x6C, 0x65, 0x00, 0x31, 0x00, 0x73, 0x76, 0x5F, 0x77, 0x61, 0x74, 0x65, 0x72,
        0x61, 0x63, 0x63, 0x65, 0x6C, 0x65, 0x72, 0x61, 0x74, 0x65, 0x00, 0x31, 0x30, 0x00, 0x73, 0x76,
        0x5F, 0x77, 0x61, 0x74, 0x65, 0x72, 0x66, 0x72, 0x69, 0x63, 0x74, 0x69, 0x6F, 0x6E, 0x00, 0x31,
        0x00
    };

    const size_t response_len = sizeof (response);

    SSQ_ERROR err;
    ssq_error_clear(&err);

    uint16_t         rule_count = 0;
    A2S_RULES *const rules      = ssq_rules_deserialize(response, response_len, &rule_count, &err);

    cr_expect_eq(err.code, SSQ_ERR_BADRES);
    cr_expect_str_eq(err.message, "Invalid A2S_RULES response header");
    cr_expect_eq(rules, NULL);
    cr_expect_eq(rule_count, 0);
}
